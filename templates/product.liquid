<div class="container">
  <div class="product-page">
    <div class="product-images">
      {% if product.featured_image %}
        <img src="{{ product.featured_image | img_url: '800x' }}" alt="{{ product.title }}" loading="lazy" id="main-product-image">
      {% else %}
        <div class="placeholder-image">{{ product.title }}</div>
      {% endif %}
      
      {% if product.images.size > 1 %}
        <div class="product-thumbnails">
          {% for image in product.images limit: 4 %}
            <img src="{{ image | img_url: '100x' }}" 
                 data-large="{{ image | img_url: '800x' }}"
                 alt="{{ product.title }} - Image {{ forloop.index }}" 
                 loading="lazy">
          {% endfor %}
        </div>
      {% endif %}
    </div>
    
    <div class="product-info">
      <h1>{{ product.title }}</h1>
      
      <div class="product-price">
        {% if product.compare_at_price > product.price %}
          <span class="price-compare">{{ product.compare_at_price | money }}</span>
          <span class="price-sale">{{ product.price | money }}</span>
          <span class="price-badge">{{ 'products.general.sale_price' | t | upcase }}</span>
        {% else %}
          {{ product.price | money }}
        {% endif %}
      </div>
      
      <div class="product-description">
        {{ product.description }}
      </div>
      
      {% form 'product', product, id: 'product-form', onsubmit: 'return addToCart(this)' %}
        <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}" id="product-variant-id">
        
        {% unless product.has_only_default_variant %}
          <div class="product-variants">
            <label for="product-select">{{ 'products.product.variant' | t }}</label>
            <select name="id" id="product-select" class="product-select">
              {% for variant in product.variants %}
                <option 
                  value="{{ variant.id }}" 
                  {% unless variant.available %}disabled{% endunless %}
                  {% if variant == product.selected_or_first_available_variant %}selected{% endif %}
                  data-price="{{ variant.price | money }}"
                  data-available="{{ variant.available }}">
                  {{ variant.title }} - {{ variant.price | money }}
                  {% unless variant.available %} ({{ 'products.product.sold_out' | t }}){% endunless %}
                </option>
              {% endfor %}
            </select>
          </div>
        {% endunless %}
        
        <div class="product-quantity">
          <label for="quantity">{{ 'products.product.quantity' | t }}</label>
          <input type="number" id="quantity" name="quantity" value="1" min="1">
        </div>
        
        <button type="submit" 
                name="add" 
                id="add-to-cart-button"
                class="btn btn--primary"
                {% unless product.available %}disabled{% endunless %}>
          <span class="btn-text">
            {% if product.available %}
              {{ 'products.product.add_to_cart' | t }}
            {% else %}
              {{ 'products.product.sold_out' | t }}
            {% endif %}
          </span>
        </button>
        
        {% if product.available %}
          <div class="product-inventory">
            {% if product.selected_or_first_available_variant.inventory_management == 'shopify' %}
              {% if product.selected_or_first_available_variant.inventory_quantity > 0 and product.selected_or_first_available_variant.inventory_quantity <= 10 %}
                <span class="low-stock">{{ 'products.product.low_stock' | t: count: product.selected_or_first_available_variant.inventory_quantity }}</span>
              {% elsif product.selected_or_first_available_variant.inventory_quantity > 0 %}
                <span class="in-stock">✓ In Stock</span>
              {% endif %}
            {% else %}
              <span class="in-stock">✓ Available</span>
            {% endif %}
          </div>
        {% endif %}
      {% endform %}
      
      {% if product.metafields.custom.ingredients %}
        <div class="product-details">
          <h3>{{ 'products.product.ingredients' | t }}</h3>
          <p>{{ product.metafields.custom.ingredients }}</p>
        </div>
      {% endif %}
      
      {% if product.metafields.custom.benefits %}
        <div class="product-details">
          <h3>{{ 'products.product.benefits' | t }}</h3>
          <p>{{ product.metafields.custom.benefits }}</p>
        </div>
      {% endif %}
      
      {% if product.metafields.custom.usage %}
        <div class="product-details">
          <h3>{{ 'products.product.usage' | t }}</h3>
          <p>{{ product.metafields.custom.usage }}</p>
        </div>
      {% endif %}
    </div>
  </div>
  
  {% if product.tags contains 'featured' %}
    <div class="related-products">
      <h2>{{ 'collections.general.explore' | t }}</h2>
      <div class="products-grid">
        {% assign related_products = collections.all.products | where: "tags", "featured" | limit: 4 %}
        {% for related_product in related_products %}
          {% unless related_product.id == product.id %}
            <div class="product-card">
              <a href="{{ related_product.url }}">
                {% if related_product.featured_image %}
                  <img src="{{ related_product.featured_image | img_url: '600x' }}" alt="{{ related_product.title }}" loading="lazy">
                {% endif %}
                <h3>{{ related_product.title }}</h3>
                <p class="product-price">{{ related_product.price | money }}</p>
              </a>
            </div>
          {% endunless %}
        {% endfor %}
      </div>
    </div>
  {% endif %}
</div>

<style>
.product-inventory {
  margin-top: var(--space-m);
  text-align: center;
  font-size: 13px;
  font-weight: 500;
  letter-spacing: 0.1em;
}

.in-stock {
  color: #4caf50;
}

.low-stock {
  color: #ff9800;
}

.product-quantity {
  margin-bottom: var(--space-m);
}

.product-quantity label {
  display: block;
  margin-bottom: var(--space-xs);
  font-size: 13px;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--color-gray);
}

.product-quantity input {
  width: 100%;
  padding: var(--space-m);
  border: 1px solid var(--color-border);
  background: var(--color-white);
  font-family: var(--font-sans);
  font-size: 16px;
  text-align: center;
}

.product-variants {
  margin-bottom: var(--space-m);
}

.product-variants label {
  display: block;
  margin-bottom: var(--space-xs);
  font-size: 13px;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--color-gray);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const variantSelect = document.getElementById('product-select');
  const addToCartButton = document.getElementById('add-to-cart-button');
  const variantIdInput = document.getElementById('product-variant-id');
  
  if (variantSelect) {
    variantSelect.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const available = selectedOption.getAttribute('data-available') === 'true';
      const variantId = selectedOption.value;
      const price = selectedOption.getAttribute('data-price');
      
      // Update hidden input
      if (variantIdInput) {
        variantIdInput.value = variantId;
      }
      
      // Update price display
      const priceElement = document.querySelector('.product-price');
      if (priceElement && price) {
        priceElement.textContent = price;
      }
      
      // Update button state
      const buttonText = addToCartButton.querySelector('.btn-text');
      if (available) {
        addToCartButton.disabled = false;
        if (buttonText) {
          buttonText.textContent = '{{ 'products.product.add_to_cart' | t }}';
        }
      } else {
        addToCartButton.disabled = true;
        if (buttonText) {
          buttonText.textContent = '{{ 'products.product.sold_out' | t }}';
        }
      }
    });
  }
});
</script>
